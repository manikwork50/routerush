<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WanderMap India ‚Äì Interactive Route Map + Weather</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root {
      --brand: #FF5E00;
      --brand-dark: #d94a00;
      --text: #222;
      --bg: #f5f5f5;
      --card: #fff;
      --muted: #666;
    }
    * {
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    body, #app {
      display: flex;
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      flex-direction: column;
    }
    /* Navigation bar: same style as index.html */
    nav {
      background: rgba(0,0,0,0);
      padding: 18px;
      text-align: center;
      user-select: none;
      box-shadow: none;
      position: relative;
      z-index: 1010;
    }
    nav a {
      color: #000;
      margin: 0 14px;
      text-decoration: none;
      font-weight: 700;
      font-size: 1rem;
      transition: color 0.3s;
      padding: 7px 9px;
      border-radius: 7px;
    }
    nav a:hover, nav a:focus {
      color: var(--brand);
      background: #fffbe9;
      outline: none;
    }
    nav a.active {
      background: #ffb347;
      color: #fff;
      font-weight: 700;
    }
    /* Main container with sidebar and map */
    #app {
      flex-direction: row;
      flex-grow: 1;
    }
    #sidebar {
      background: var(--card);
      width: 360px;
      min-width: 250px;
      max-width: 100vw;
      box-shadow: 2px 0 14px rgb(207 207 207 / 0.11);
      padding: 26px 24px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%;
      overflow-y: auto;
      z-index: 2;
    }
    label {
      font-weight: 600;
      font-size: 1em;
      margin-bottom: 5px;
    }
    input, select {
      padding: 11px 13px;
      border: 1.2px solid #ccc;
      border-radius: 7px;
      width: 100%;
      font-size: 1rem;
      margin-bottom: 12px;
      outline-offset: 2px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 1.5px #fcbe8744;
      outline: none;
    }
    button {
      background-color: var(--brand);
      color: #fff;
      font-weight: 700;
      font-size: 1.07em;
      border: none;
      border-radius: 7px;
      padding: 13px 0;
      cursor: pointer;
      margin-bottom: 10px;
      transition: background 0.13s;
      box-shadow: 0 2px 10px #ff7b0077;
    }
    button:disabled {
      background: #d7d7d7;
      color: #8d8d8d;
      cursor: not-allowed;
    }
    button:focus, button:hover:not(:disabled) {
      background-color: var(--brand-dark);
      outline: none;
    }
    #weatherPanel {
      margin-bottom: 10px;
    }
    .weather {
      background: #e3f5ff;
      border-radius: 7px;
      padding: 8px 14px;
      margin-bottom: 7px;
      font-size: 1.03em;
      color: #236076;
    }
    .weatherloc {
      font-weight: 700;
      color: #2d5969;
    }
    .weather-main {
      font-size: 1.09em;
      font-weight: 600;
    }
    .weathericon {
      font-size: 1.15em;
      margin-right: 6px;
    }
    .route-title {
      font-weight: 800;
      color: var(--brand);
      margin-bottom: 8px;
    }
    .costtag {
      font-weight: 800;
      color: #008651;
    }
    .step-list {
      margin-top: 9px;
      padding-left: 12px;
    }
    .step-list li {
      margin-bottom: 6px;
      font-size: 0.97em;
      color: #444;
    }
    #routePanel {
      margin-top: 6px;
      overflow-y: auto;
      max-height: 250px;
    }
    #map {
      flex: 1 1 auto;
      height: 100vh;
      min-width: 0;
      position: relative;
    }
    /* Responsive adjustments */
    @media (max-width: 850px) {
      #app {
        flex-direction: column;
      }
      #sidebar {
        width: 100vw;
        height: auto;
        box-shadow: none;
        border-bottom: 2px solid #f2f2f2;
        max-width: none;
        padding-right: 12px;
      }
      #map {
        height: 62vh;
      }
    }
    @media (max-width: 540px) {
      #sidebar {
        padding: 13px 2vw 8px 2vw;
      }
    }
  </style>
</head>
<body>
  <nav aria-label="Primary Navigation">
    <a href="index.html">Home</a>
    <a href="map.html" class="active" aria-current="page">Map</a>
    <a href="blog.html">Blog</a>
    <a href="bookings.html">Bookings</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
  </nav>
  <div id="app">
    <aside id="sidebar" role="region" aria-label="Route and Weather Search">
      <label for="from">From location</label>
      <input id="from" placeholder="Enter start location" autocomplete="off" aria-required="true" />
      <label for="to">To location</label>
      <input id="to" placeholder="Enter destination" autocomplete="off" aria-required="true" />
      <label for="mode">Travel mode</label>
      <select id="mode" aria-required="true" aria-label="Select mode of travel">
        <option value="DRIVING" selected>By Road</option>
        <option value="WALKING">Walk</option>
        <option value="TRANSIT">By Train</option>
      </select>
      <button id="routeBtn" disabled>Show Route</button>
      <button id="geoBtn" style="background:#25D366;color:#fff;">Use My Location</button>
      <div id="weatherPanel" aria-live="polite"></div>
      <div id="routePanel" aria-live="polite"></div>
    </aside>
    <div id="map" aria-label="Map showing route and directions"></div>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC7NzB6il5P8g1IkkiA8rfmi_f4tPnVr84&libraries=places&callback=initMap" async defer></script>
  <script>
    let map, directionsService, directionsRenderer, geoCoder;
    const rates = { driving: { perKm: 13 }, walking: { perKm: 0 }, train: { perKm: 1}};

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 22.9734, lng: 78.6569 },
        zoom: 5,
        streetViewControl: false,
        mapTypeControl: false,
        fullscreenControl: true,
        zoomControl: true
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false });
      geoCoder = new google.maps.Geocoder();

      const fromInput = document.getElementById('from');
      const toInput = document.getElementById('to');
      const routeBtn = document.getElementById('routeBtn');
      const geoBtn = document.getElementById('geoBtn');

      new google.maps.places.Autocomplete(fromInput);
      new google.maps.places.Autocomplete(toInput);

      function validateInputs() {
        const valid = fromInput.value.trim() !== '' && toInput.value.trim() !== '';
        routeBtn.disabled = !valid;
        routeBtn.setAttribute('aria-disabled', !valid);
      }

      fromInput.addEventListener('input', validateInputs);
      toInput.addEventListener('input', validateInputs);

      routeBtn.addEventListener('click', () => {
        calcRoute(
          fromInput.value.trim(),
          toInput.value.trim(),
          document.getElementById('mode').value
        );
      });

      geoBtn.addEventListener('click', geoLocate);
    }

    async function getCoords(address) {
      return new Promise((resolve, reject) => {
        geoCoder.geocode({ address: address }, (results, status) => {
          if (status === 'OK' && results[0]) {
            const loc = results[0].geometry.location;
            resolve({ lat: loc.lat(), lng: loc.lng() });
          } else {
            reject('Could not geocode ' + address);
          }
        });
      });
    }

    function displayWeather(data, placeName) {
      const panel = document.getElementById('weatherPanel');
      if (!data || !data.current_weather) return;
      const weather = data.current_weather;
      const temp = weather.temperature.toFixed(1);
      const wind = weather.windspeed.toFixed(1);
      const icons = {
        0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è', 51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è', 56: 'üåßÔ∏è', 57: 'üåßÔ∏è',
        61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è', 66: 'üå®Ô∏è', 67: 'üå®Ô∏è', 71: '‚ùÑÔ∏è', 73: '‚ùÑÔ∏è', 75: '‚ùÑÔ∏è', 80: 'üå¶Ô∏è', 81: 'üåßÔ∏è',
        82: 'üåßÔ∏è', 95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
      };
      const icon = icons[weather.weathercode] || '‚ùì';
      const html = `
        <div class="weather" role="region" aria-label="Weather for ${placeName}">
          <div class="weatherloc">${placeName}</div>
          <div class="weather-main">
            <span class="weathericon">${icon}</span>
            <span>${temp}¬∞C</span>
            <span style="font-size:.93em; color:#246">${wind} km/h wind</span>
          </div>
        </div>
      `;
      panel.insertAdjacentHTML('beforeend', html);
    }

    async function fetchWeather(lat, lng, placeName) {
      try {
        const req = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
        const data = await req.json();
        displayWeather(data, placeName);
      } catch {}
    }

    async function calcRoute(from, to, mode) {
      document.getElementById('weatherPanel').innerHTML = '';
      document.getElementById('routePanel').innerHTML = '';
      try {
        const [fromC, toC] = await Promise.all([getCoords(from), getCoords(to)]);
        fetchWeather(fromC.lat, fromC.lng, 'From: ' + from);
        fetchWeather(toC.lat, toC.lng, 'To: ' + to);

        const travelMode = google.maps.TravelMode[mode];
        const request = {
          origin: from,
          destination: to,
          travelMode: travelMode,
          provideRouteAlternatives: false,
          ...(mode === 'TRANSIT' ? { transitOptions: { modes: ['TRAIN'] } } : {})
        };

        directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            directionsRenderer.setDirections(result);
            displayRouteDetails(result.routes[0], mode);
          } else {
            alert('No route found or error: ' + status);
            directionsRenderer.setDirections({ routes: [] });
            document.getElementById('routePanel').innerHTML = '';
          }
        });
      } catch (err) {
        alert(err);
      }
    }

    function displayRouteDetails(route, mode) {
      if (!route || !route.legs || route.legs.length === 0) {
        document.getElementById('routePanel').innerHTML = '<p>No route details available.</p>';
        return;
      }
      const leg = route.legs[0];
      const km = leg.distance.value / 1000;
      let fare = 0;
      if (mode === 'DRIVING') fare = (km * rates.driving.perKm).toFixed(0);
      else if (mode === 'WALKING') fare = 0;
      else if (mode === 'TRANSIT') fare = (km * rates.train.perKm).toFixed(0);

      let html = `<div class="route-title">Travel Details</div>
                  <div><b>From:</b> ${leg.start_address} <br><b>To:</b> ${leg.end_address}</div>
                  <div class="route-mode"><b>Mode:</b> ${mode === 'DRIVING' ? 'By Road' : (mode === 'WALKING' ? 'Walk' : 'By Train')}</div>
                  <div class="time-display"><b>Time:</b> ${leg.duration.text}</div>
                  <div class="distance-display"><b>Distance:</b> ${leg.distance.text}</div>
                  <span class="costtag">Estimated Fare: ${mode === 'WALKING' ? 'Free' : `‚Çπ${fare}`}</span>`;

      if (leg.steps && leg.steps.length > 0) {
        html += '<ul class="step-list">';
        leg.steps.forEach(step => {
          const instr = step.instructions.replace(/<[^>]+>/g, '');
          html += `<li>${instr} (${step.distance.text}, ${step.duration.text})</li>`;
        });
        html += '</ul>';
      }

      document.getElementById('routePanel').innerHTML = html;
    }

    function geoLocate() {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser.');
        return;
      }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        try {
          const response = await new Promise((resolve, reject) => {
            geoCoder.geocode({ location: latlng }, (res, status) => {
              if (status === 'OK' && res && res[0]) resolve(res);
              else reject(status);
            });
          });
          document.getElementById('from').value = response[0].formatted_address;
          const routeBtn = document.getElementById('routeBtn');
          const valid = document.getElementById('from').value.trim() !== '' && document.getElementById('to').value.trim() !== '';
          routeBtn.disabled = !valid;
          routeBtn.setAttribute('aria-disabled', !valid);
        } catch {
          alert('Unable to detect address from your location.');
        }
      }, () => alert('Permission denied or location unavailable.'));
    }
  </script>
</body>
</html>
